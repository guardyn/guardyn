set shell := ["bash", "-euo", "pipefail", "-c"]
set dotenv-load := false

CLUSTER_NAME := "guardyn-poc"
K3D_CONFIG := "infra/k3d-config.yaml"

default:
	@just --list

kube\:create:
	@echo "[kube:create] Creating k3d cluster using ${K3D_CONFIG}"
	k3d cluster create --config "${K3D_CONFIG}"

kube\:delete:
	@echo "[kube:delete] Deleting k3d cluster ${CLUSTER_NAME}"
	k3d cluster delete "${CLUSTER_NAME}" || true

kube\:bootstrap:
	@echo "[kube:bootstrap] Applying base namespaces"
	kubectl apply -k infra/k8s/base/namespaces
	@echo "[kube:bootstrap] Installing operators and core addons"
	kubectl apply -k infra/k8s/base/cert-manager
	kubectl apply -k infra/k8s/base/cilium
	kubectl apply -k infra/k8s/base/tikv
	kubectl apply -k infra/k8s/base/scylladb
	kubectl apply -k infra/k8s/base/monitoring

k8s\:deploy service:
	case "{{service}}" in \
		nats)
			helm repo add nats https://nats-io.github.io/k8s/helm/charts >/dev/null
			helm repo update >/dev/null
			helm upgrade --install nats nats/nats \
				--namespace messaging \
				--create-namespace \
				--values infra/k8s/base/nats/values.yaml
			;;
		foundationdb)
			echo "[DEPRECATED] FoundationDB replaced with TiKV. Use 'tikv' instead."
			exit 1
			;;
		tikv)
			helm repo add pingcap https://charts.pingcap.org/ >/dev/null
			helm repo update >/dev/null
			helm upgrade --install tikv-cluster pingcap/tidb-cluster \
				--namespace data \
				--create-namespace \
				--values infra/k8s/base/tikv/values.yaml
			;;
		scylladb)
			helm repo add scylla https://scylla-operator-charts.storage.googleapis.com/stable >/dev/null
			helm repo update >/dev/null
			helm upgrade --install scylla-cluster scylla/scylla-operator \
				--namespace data \
				--create-namespace \
				--values infra/k8s/base/scylladb/values.yaml
			;;
		monitoring)
			helm repo add grafana https://grafana.github.io/helm-charts >/dev/null
			helm repo add prometheus-community https://prometheus-community.github.io/helm-charts >/dev/null
			helm repo update >/dev/null
			helm upgrade --install kube-prometheus-stack prometheus-community/kube-prometheus-stack \
				--namespace observability \
				--create-namespace \
				--values infra/k8s/base/monitoring/values.yaml
			helm upgrade --install grafana-loki grafana/loki-distributed \
				--namespace observability \
				--values infra/k8s/base/monitoring/loki-values.yaml
			;;
		*)
			echo "Unsupported service '{{service}}'" >&2
			exit 1
			;;
	esac

verify\:kube:
	@echo "[verify:kube] Checking node status"
	kubectl get nodes -o wide
	@echo "[verify:kube] Waiting for system pods to become ready"
	kubectl wait --for=condition=Ready pods --all --timeout=180s --all-namespaces
	@echo "[verify:kube] Verifying NATS JetStream"
	kubectl run nats-smoke --rm -i --restart=Never --namespace messaging --image=natsio/nats-box:latest \
		-- /bin/sh -c "nats server check jetstream || nats -s nats://nats:4222 sub foo & sleep 2 && nats -s nats://nats:4222 pub foo 'hello'"
	@echo "[verify:kube] Checking TiKV cluster (PD)"
	kubectl -n data exec -it svc/pd -- /pd-ctl -u http://localhost:2379 store
	@echo "[verify:kube] Checking ScyllaDB nodes"
	kubectl -n data run scylla-nodecheck --rm -i --restart=Never --image=scylladb/scylla:5.4 \
		-- bash -c "nodetool status"

db\:deploy-schemas:
	@echo "[db:deploy-schemas] Deploying database schemas"
	bash infra/scripts/deploy-schemas.sh

teardown:
	@echo "[teardown] Destroying cluster and cleaning up"
	just kube:delete
